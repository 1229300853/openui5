<!DOCTYPE HTML>

<!--
	Tested class: sap.ui.core.util.XMLPreprocessor
-->

<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<script id="sap-ui-bootstrap"
		type="text/javascript"
		src="../../../../../../resources/sap-ui-core.js"
		data-sap-ui-theme="sap_bluecrystal">
	</script>
	<link rel="stylesheet"
		href="../../../../../../resources/sap/ui/thirdparty/qunit.css"
		type="text/css" media="screen" />
	<script src="../../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
	<script src="../../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
	<script src="../../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
	<script src="../../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
	<script src="../../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

	<script>
	/*global asyncTest, deepEqual, equal, expect, module, notDeepEqual,
	notEqual, notStrictEqual, ok, raises, sinon, start, strictEqual, stop, test,
	sinon, window */

	jQuery.sap.require("jquery.sap.xml");
	jQuery.sap.require("sap.ui.core.util.XMLPreprocessor");

	// default error handler
	function onRejected(oError) {
		start(); // MUST be called before an assertion which fails!
		ok(false, oError);
	}

	/**
	 * Creates an <mvc:View> tag with namespace definitions and isTemplate="true".
	 * @param {string} [sPrefix="template"] the prefix for the template namespace
	 * @returns {string}
	 */
	function mvcView(sPrefix) {
		sPrefix = sPrefix || "template";
		return '<mvc:View xmlns="sap.ui.core" xmlns:mvc="sap.ui.core.mvc" isTemplate="true" xmlns:'
			+ sPrefix + '="http://schemas.sap.com/sapui5/extension/sap.ui.core.template/1">';
	}

	/**
	 * Creates an DOM document from the given strings.
	 * @param {string[]} aContent the content
	 * @returns {Element} the DOM document's root element
	 */
	function xml(aContent) {
		var oDocument = jQuery.sap.parseXML(aContent.join(""));
		strictEqual(oDocument.parseError.errorCode, 0, "XML parsed correctly");
		return oDocument.documentElement;
	}

	// remove all namespaces and all spaces before tag ends (..."/>)
	function normalizeXml(sXml) {
		/*jslint regexp: true*/
		// different browsers return different strings while serializing XML documents
		// not interested in whitespaces or namespaces so remove them
		return sXml.replace(/ xmlns.*?=\".+?\"/g,"").replace(/ \/>/g,'/>');
	}

	/**
	 * Checks if document is equal to the concatenation of a subset of given strings (with
     * isTemplate adjusted accordingly).
     * @param {Element} oElement the actual XML document's root element
     * @param {string[]} aStrings a superset of the expected XML
	 * @param {number[]} [aIndices]
	 *   indicates which subset of the given strings to use; default is all
	 * @param {boolean} [bIsTemplate=false]
	 *	 the expected value for isTemplate
	 */
	function checkXml(oElement, aStrings, aIndices, bIsTemplate) {
		var sActual = normalizeXml(jQuery.sap.serializeXML(oElement)),
			sExpected = "";
		if (aIndices) {
			jQuery.each(aIndices, function (i, iIndex) {
				sExpected += aStrings[iIndex];
			});
		} else {
			sExpected = aStrings.join("");
		}
		bIsTemplate = !!bIsTemplate; // make it a real boolean
		sExpected = normalizeXml(sExpected)
			.replace(/isTemplate="true"/, 'isTemplate="' + bIsTemplate + '"');
		strictEqual(sActual, sExpected, "XML looks as expected: " + sExpected);
	}

	// WARNING! These are on by default and break the Promise polyfill...
	sinon.config.useFakeTimers = false;

	//*********************************************************************************************
	module("sap.ui.core.util.XmlPreprocessor", {
		teardown: function () {
			if (jQuery.sap.log.warning.restore) {
				jQuery.sap.log.warning.restore();
			}
			if (sap.ui.base.ManagedObject.prototype.bindAggregation.restore) {
				sap.ui.base.ManagedObject.prototype.bindAggregation.restore();
			}
			if (sap.ui.base.ManagedObject.prototype.unbindAggregation.restore) {
				sap.ui.base.ManagedObject.prototype.unbindAggregation.restore();
			}
			if (sap.ui.base.ManagedObject.prototype.bindProperty.restore) {
				sap.ui.base.ManagedObject.prototype.bindProperty.restore();
			}
			if (sap.ui.base.ManagedObject.prototype.unbindProperty.restore) {
				sap.ui.base.ManagedObject.prototype.unbindProperty.restore();
			}
			try {
				delete window.foo;
			} catch (e) {
				// IE 8 doesn't like this: "Object doesn't support this action"
			}
		}
	});

	//*********************************************************************************************
	jQuery.each(['', ' isTemplate="foo"'],
		function (i, sTemplateSpec) {
			test("XML w/o isTemplate is unchanged (" + i + ")", function () {
				var aViewContent = [
				        mvcView().replace(/ isTemplate="true"/, sTemplateSpec),
						'<Icon visibility="{/uistate/visibility}"/>',
						'<template:if test="false">',
						'<Icon/>',
						'<\/template:if>',
						'<\/mvc:View>'
					],
					oViewContent = xml(aViewContent);

				sap.ui.core.util.XMLPreprocessor.process(oViewContent, {});

				checkXml(oViewContent, aViewContent, undefined, true);
			});
		});

	//*********************************************************************************************
	test("XML with template:if test='false'", function () {
		var aViewContent = [
				mvcView("t"),
				'<t:if test="false">',
				'<Icon/>',
				'<\/t:if>',
				'<!-- prevent empty tag -->',
				'<\/mvc:View>'
			],
			oViewContent = xml(aViewContent);

		// Note: no mSettings!
		sap.ui.core.util.XMLPreprocessor.process(oViewContent);

		checkXml(oViewContent, aViewContent, [0, 4, 5]);
	});

	//*********************************************************************************************
	test("XML with template:if test='true'", function () {
		var aViewContent = [
				mvcView(),
				'<template:if test="true">',
				'<Icon id="first"/>',
				'<Icon id="true"/>',
				'<Icon id="last"/>',
				'<\/template:if>',
				'<\/mvc:View>'
			],
			oViewContent = xml(aViewContent);

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {});

		checkXml(oViewContent, aViewContent, [0, 2, 3, 4, 6]);
	});

	//*********************************************************************************************
	test("XML with multiple template:if", function () {
		var aViewContent = [
				mvcView(),
				'<template:if test="true">',
				'<Icon id="true"/>',
				'<\/template:if>',
				'<template:if test="false">',
				'<Icon id="false"/>',
				'<\/template:if>',
				'<\/mvc:View>'
			],
			oViewContent = xml(aViewContent);

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {});

		checkXml(oViewContent, aViewContent, [0, 2, 7]);
	});

	//*********************************************************************************************
	test("XML with nested template:if (as last child)", function () {
		var aViewContent = [
				mvcView(),
				'<template:if test="true">',
				'<Icon id="true"/>',
				'<template:if test="false">',
				'<Icon id="false"/>',
				'<\/template:if>',
				'<\/template:if>',
				'<\/mvc:View>'
			],
			oViewContent = xml(aViewContent);

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {});

		checkXml(oViewContent, aViewContent, [0, 2, 7]);
	});

	//*********************************************************************************************
	test("XML with nested template:if (as inner child)", function () {
		var aViewContent = [
				mvcView(),
				'<template:if test="true">',
				'<Icon id="true"/>',
				'<template:if test="false">',
				'<Icon id="false"/>',
				'<\/template:if>',
				'<template:if test="false">', // this must also be processed, of course!
				'<\/template:if>',
				'<\/template:if>',
				'<\/mvc:View>'
			],
			oViewContent = xml(aViewContent);

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {});

		checkXml(oViewContent, aViewContent, [0, 2, 9]);
	});

	//*********************************************************************************************
	// Note: "X" is really nothing special
	jQuery.each(["true", true, 1, "X"], function (i, oFlag) {
		test("XML with template:if test='{/flag}', truthy, flag = " + oFlag,
			function () {
				var aViewContent = [
						mvcView("t"),
						'<t:if test="{path: \'/flag\', type: \'sap.ui.model.type.Boolean\'}">',
						'<Icon/>',
						'<\/t:if>',
						'<\/mvc:View>'
					],
					oModel = new sap.ui.model.json.JSONModel({flag: oFlag}),
					oViewContent = xml(aViewContent),
					fnBindProperty = sap.ui.base.ManagedObject.prototype.bindProperty;

				sinon.stub(sap.ui.base.ManagedObject.prototype, "bindProperty",
					function (sName, oBindingInfo) {
						strictEqual(sName, "any");
						strictEqual(oBindingInfo.mode, sap.ui.model.BindingMode.OneTime);
						fnBindProperty.apply(this, arguments);
					});
				sinon.spy(sap.ui.base.ManagedObject.prototype, "unbindProperty");

				sap.ui.core.util.XMLPreprocessor.process(oViewContent, {models: oModel});

				checkXml(oViewContent, aViewContent, [0, 2, 4]);
				strictEqual(sap.ui.base.ManagedObject.prototype.unbindProperty.callCount,
					sap.ui.base.ManagedObject.prototype.bindProperty.callCount,
					"balance of bind and unbind");
				ok(sap.ui.base.ManagedObject.prototype.unbindProperty
					.alwaysCalledWith("any", true));
			});
	});

	//*********************************************************************************************
	// Note: " " intentionally not included yet, should not matter for OData!
	jQuery.each(["false", false, 0, null, undefined, NaN, ""], function (i, oFlag) {
		test("XML with template:if test='{/flag}', falsy, flag = " + oFlag,
			function () {
				var aViewContent = [
						mvcView(),
						'<template:if test="{/flag}">',
						'<Icon id="flag"/>',
						'<\/template:if>',
						'<!-- prevent empty tag -->',
						'<\/mvc:View>'
					],
					oModel = new sap.ui.model.json.JSONModel({flag: oFlag}),
					oViewContent = xml(aViewContent);

				sap.ui.core.util.XMLPreprocessor.process(oViewContent, {models: oModel});

				checkXml(oViewContent, aViewContent, [0, 4, 5]);
			});
	});

	//*********************************************************************************************
	// Note: relative paths now!
	jQuery.each(["true", true, 1, "X"], function (i, oFlag) {
		asyncTest("XML with template:if test='{flag}', truthy, flag = " + oFlag,
			function () {
				var aViewContent = [
						mvcView(),
						'<template:if test="{flag}">',
						'<Icon/>',
						'<\/template:if>',
						'<\/mvc:View>'
					],
					oModel = new sap.ui.model.json.JSONModel({flag: oFlag}),
					oViewContent = xml(aViewContent);

				oModel.createBindingContext("/", /*oContext*/null,	/*mParameters*/null,
						function (oContext) {
							start();
							sap.ui.core.util.XMLPreprocessor.process(oViewContent,
								{models: oModel, bindingContexts: oContext});
							checkXml(oViewContent, aViewContent, [0, 2, 4]);
						}
				);
			});
	});

	//*********************************************************************************************
	test("XML with template:if test='{formatter:...}'", function () {
		var aViewContent = [
				mvcView(),
				'<template:if test="{formatter: \'foo.Helper.not\', path:\'/flag\'}">',
				'<Icon id="flag"/>',
				'<\/template:if>',
				'<\/mvc:View>'
			],
			oModel = new sap.ui.model.json.JSONModel({flag: false}),
			oViewContent = xml(aViewContent);

		window.foo = {
			Helper: {
				not: function (oRawValue) {
					return !oRawValue;
				}
			}
		};

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {models: oModel});

		checkXml(oViewContent, aViewContent, [0, 2, 4]);
	});

	//*********************************************************************************************
	test("template:if test='{formatter:...}', exception in formatter", function () {
		var oError = new Error("deliberate failure"),
			sTest = "{formatter: 'foo.Helper.fail', path:'/flag'}",
			aViewContent = [
				mvcView(),
				'<template:if test="' + sTest + '">',
				'<Icon id="flag"/>',
				'<\/template:if>',
				'<!-- prevent empty tag -->',
				'<\/mvc:View>'
			],
			oModel = new sap.ui.model.json.JSONModel({flag: true}),
			oViewContent = xml(aViewContent);

		sinon.spy(jQuery.sap.log, "warning");
		window.foo = {
			Helper: {
				fail: function (oRawValue) {
					throw oError;
				}
			}
		};

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {models: oModel, viewName: "foo"});

		//TODO catch with warning vs. an error thrown?
		ok(jQuery.sap.log.warning.calledWith(
			'Error in formatter of ' + aViewContent[1] + ' in view foo',
			oError, "sap.ui.core.mvc.XMLView"));
		checkXml(oViewContent, aViewContent, [0, 4, 5]);
	});

	//*********************************************************************************************
	test("Do not process nested template:ifs if not necessary", function () {
		var aViewContent = [
				mvcView(),
				'<template:if test="false">',
				'<Icon id="false"/>',
				'<template:if test="{formatter: \'foo.Helper.forbidden\', path:\'/flag\'}">',
				'<Icon id="forbidden"/>',
				'<\/template:if>',
				'<\/template:if>',
				'<!-- prevent empty tag -->',
				'<\/mvc:View>'
			],
			oModel = new sap.ui.model.json.JSONModel({flag: true}),
			oViewContent = xml(aViewContent);

		window.foo = {
				Helper: {
					forbidden: function (oRawValue) {
						ok(false, "formatter MUST not be called!");
					}
				}
			};

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {models: oModel});

		checkXml(oViewContent, aViewContent, [0, 7, 8]);
	});

	//*********************************************************************************************
	test("XML with template:if test='false' and template:then", function () {
		var aViewContent = [
				mvcView(),
				'<template:if test="false">',
				'<template:then>',
				'<Icon/>',
				'<\/template:then>',
				'<\/template:if>',
				'<!-- prevent empty tag -->',
				'<\/mvc:View>'
			],
			oViewContent = xml(aViewContent);

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {});

		checkXml(oViewContent, aViewContent, [0, 6, 7]);
	});

	//*********************************************************************************************
	test("XML with template:if test='true' and template:then", function () {
		var aViewContent = [
				mvcView(),
				'<template:if test="true">',
				'<!-- some text node -->',
				'<template:then>',
				'<Icon/>',
				'<\/template:then>',
				'<\/template:if>',
				'<\/mvc:View>'
			],
			oViewContent = xml(aViewContent);

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {});

		checkXml(oViewContent, aViewContent, [0, 4, 7]);
	});

	//*********************************************************************************************
	test("XML with nested template:if test='true' and template:then", function () {
		var aViewContent = [
				mvcView(),
				// it is essential for the test that there is not tag between the if's
				'<template:if test="true">',
				'<template:if test="true">',
				'<template:then>',
				'<Icon id="icon2"/>',
				'<\/template:then>',
				'<\/template:if>',
				'<\/template:if>',
				'<\/mvc:View>'
			],
			oViewContent = xml(aViewContent);

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {});

		checkXml(oViewContent, aViewContent, [0, 4, 8]);
	});

	//*********************************************************************************************
	test("XML with template:if test='true' and template:then/else", function () {
		var aViewContent = [
				mvcView(),
				'<template:if test="true">',
				'<template:then>',
				'<Icon id="true"/>',
				'<\/template:then>',
				'<!-- some text node -->',
				'<template:else>',
				'<Icon id="false"/>',
				'<\/template:else>',
				'<\/template:if>',
				'<\/mvc:View>'
			],
			oViewContent = xml(aViewContent);

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {});

		checkXml(oViewContent, aViewContent, [0, 3, 10]);
	});

	//*********************************************************************************************
	test("XML with template:if test='false' and template:then/else", function () {
		var aViewContent = [
				mvcView(),
				'<template:if test="false">',
				'<template:then>',
				'<Icon id="true"/>',
				'<\/template:then>',
				'<template:else>',
				'<Icon id="false"/>',
				'<\/template:else>',
				'<\/template:if>',
				'<\/mvc:View>'
			],
			oViewContent = xml(aViewContent);

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {});

		checkXml(oViewContent, aViewContent, [0, 6, 9]);
	});

	//*********************************************************************************************
	test("XML with nested template:if test='true' and template:then/else",
		function () {
			var aViewContent = [
					mvcView(),
					'<template:if test="true">',
					'<Icon id="icon1"/>',
					'<template:if test="false">',
					'<template:then>',
					'<Icon id="icon2"/>',
					'<\/template:then>',
					'<template:else>',
					'<Icon id="icon3"/>',
					'<\/template:else>',
					'<\/template:if>',
					'<\/template:if>',
					'<\/mvc:View>'
				],
				oViewContent = xml(aViewContent);

			sap.ui.core.util.XMLPreprocessor.process(oViewContent, {});

			checkXml(oViewContent, aViewContent, [0, 2, 8, 12]);
		}
	);

	//*********************************************************************************************
	test("error handling: unexpected else",
		function () {
			var aViewContent = [
					mvcView(),
					'<template:if test="true">',
					'<template:else>',
					'<Icon id="icon3"/>',
					'<\/template:else>',
					'<template:then>',
					'<Icon id="icon2"/>',
					'<\/template:then>',
					'<\/template:if>',
					'<\/mvc:View>'
				],
				oViewContent = xml(aViewContent);

			try {
				sap.ui.core.util.XMLPreprocessor.process(oViewContent, {viewName: "foo"});
				ok(false);
			} catch (e) {
				strictEqual(e.message, "Unexpected tag " + aViewContent[2] + ' in '
					+ aViewContent[1] + ' in view foo');
			}
		}
	);

	//*********************************************************************************************
	test("error handling: mix of template:then/else tag and other tags (1)",
		function () {
			var aViewContent = [
					mvcView(),
					'<template:if test="true">',
					'<Icon id="icon0"/>',
					'<template:then>',
					'<Icon id="icon2"/>',
					'<\/template:then>',
					'<template:else>',
					'<Icon id="icon3"/>',
					'<\/template:else>',
					'<\/template:if>',
					'<\/mvc:View>'
				],
				oViewContent = xml(aViewContent);

			sap.ui.core.util.XMLPreprocessor.process(oViewContent, {});
			// if there is neither then nor else as first child do not replace then and else
			// children; use core runtime error handling
			checkXml(oViewContent, aViewContent, [0, 2, 3, 4, 5, 6, 7, 8, 10]);
		}
	);

	//*********************************************************************************************
	test("error handling: mix of template:then/else tag and other tags (2)",
		function () {
			var aViewContent = [
					mvcView(),
					'<template:if test="true">',
					'<template:then>',
					'<Icon id="icon2"/>',
					'<\/template:then>',
					'<Icon id="icon0"/>',
					'<template:else>',
					'<Icon id="icon3"/>',
					'<\/template:else>',
					'<\/template:if>',
					'<\/mvc:View>'
				],
				oViewContent = xml(aViewContent);

			try {
				sap.ui.core.util.XMLPreprocessor.process(oViewContent, {viewName: "foo"});
				ok(false);
			} catch (e) {
				strictEqual(e.message, 'Unexpected tag ' + aViewContent[5] + ' in '
					+ aViewContent[1] + ' in view foo');
			}
		}
	);

	//*********************************************************************************************
	test("error handling: mix of template:then/else tag and other tags (3)",
		function () {
			var aViewContent = [
					mvcView(),
					'<template:if test="true">',
					'<template:then>',
					'<Icon id="icon2"/>',
					'<\/template:then>',
					'<template:else>',
					'<Icon id="icon3"/>',
					'<\/template:else>',
					'<!-- some text node -->',
					'<Icon id="icon0"/>',
					'<\/template:if>',
					'<\/mvc:View>'
				],
				oViewContent = xml(aViewContent);

			try {
				sap.ui.core.util.XMLPreprocessor.process(oViewContent, {viewName: "foo"});
				ok(false);
			} catch (e) {
				strictEqual(e.message, 'Unexpected tag ' + aViewContent[9] + ' in '
						+ aViewContent[1] + ' in view foo');
			}
		}
	);

	//*********************************************************************************************
	test("error handling: mix of template:then tag and other tags (4)",
		function () {
			var aViewContent = [
					mvcView(),
					'<template:if test="true">',
					'<template:then>',
					'<Icon id="icon2"/>',
					'<\/template:then>',
					'<Icon id="icon0"/>',
					'<Label id="label0"/>',
					'<\/template:if>',
					'<\/mvc:View>'
				],
				oViewContent = xml(aViewContent);

			try {
				sap.ui.core.util.XMLPreprocessor.process(oViewContent, {viewName: "foo"});
				ok(false);
			} catch (e) {
				strictEqual(e.message, 'Unexpected tag ' + aViewContent[5] + ' in '
					+ aViewContent[1] + ' in view foo');
			}
		}
	);

	//*********************************************************************************************
	test("error handling: 2x template:then",
		function () {
			var aViewContent = [
					mvcView(),
					'<template:if test="true">',
					'<template:then>',
					'<Icon id="icon2"/>',
					'<\/template:then>',
					'<template:then>',
					'<Icon id="icon3"/>',
					'<\/template:then>',
					'<\/template:if>',
					'<\/mvc:View>'
				],
				oViewContent = xml(aViewContent);

			try {
				sap.ui.core.util.XMLPreprocessor.process(oViewContent, {viewName: "foo"});
				ok(false);
			} catch (e) {
				strictEqual(e.message, 'Unexpected tag ' + aViewContent[5] + ' in '
					+ aViewContent[1] + ' in view foo');
			}
		}
	);

	//*********************************************************************************************
	test("error handling: 2x template:else",
		function () {
			var aViewContent = [
					mvcView(),
					'<template:if test="true">',
					'<template:then>',
					'<Icon id="icon2"/>',
					'<\/template:then>',
					'<template:else>',
					'<Icon id="icon3"/>',
					'<\/template:else>',
					'<template:else id="2nd">',
					'<Icon id="icon4"/>',
					'<\/template:else>',
					'<\/template:if>',
					'<\/mvc:View>'
				],
				oViewContent = xml(aViewContent);

			try {
				sap.ui.core.util.XMLPreprocessor.process(oViewContent, {viewName: "foo"});
				ok(false);
			} catch (e) {
				strictEqual(e.message, 'Unexpected tag ' + aViewContent[8] + ' in '
					+ aViewContent[1] + ' in view foo');
			}
		}
	);

	//*********************************************************************************************
	test("error handling without view name",
		function () {
			var aViewContent = [
					mvcView(),
					'<template:if test="true">',
					'<template:then>',
					'<Icon id="icon2"/>',
					'<\/template:then>',
					'<template:else>',
					'<Icon id="icon3"/>',
					'<\/template:else>',
					'<template:else id="2nd">',
					'<Icon id="icon4"/>',
					'<\/template:else>',
					'<\/template:if>',
					'<\/mvc:View>'
				],
				oViewContent = xml(aViewContent);

			try {
				sap.ui.core.util.XMLPreprocessor.process(oViewContent, {});
				ok(false);
			} catch (e) {
				strictEqual(e.message, 'Unexpected tag ' + aViewContent[8] + ' in '
					+ aViewContent[1] + ' in view undefined');
			}
		}
	);

	//*********************************************************************************************
	test("binding resolution", function () {
		var oModel = new sap.ui.model.json.JSONModel({
				"com.sap.vocabularies.UI.v1.HeaderInfo": {
					"TypeImageUrl" : {
						"String" : "/coco/apps/main/img/Icons/product_48.png"
					},
					"Title": {
						"Label": {
							"String": "Customer"
						},
						"Value": {
							"Path": "CustomerName"
						}
					}
				}
			}),
			aTemplateContent = [
				mvcView().replace(">", ' xmlns:html="http://www.w3.org/1999/xhtml">'),
				'<template:foo>',
				'<Label text="{formatter: \'foo.Helper.help\','
					+ ' path: \'/com.sap.vocabularies.UI.v1.HeaderInfo/Title/Label\'}"/>',
				'<Text text="{formatter: \'foo.Helper.help\','
					+ ' path: \'/com.sap.vocabularies.UI.v1.HeaderInfo/Title/Value\'}"/>',
				'<html:img src="{formatter: \'foo.Helper.help\','
					+ ' path: \'/com.sap.vocabularies.UI.v1.HeaderInfo/TypeImageUrl\'}"/>',
				'<\/template:foo>',
				'<\/mvc:View>'
			],
			aExpectedViewContent = [
				aTemplateContent[0],
				'<template:foo>', // must remain so that standard error handling complains
				'<Label text="Customer"/>',
				'<Text text="{CustomerName}"/>',
				// TODO is this the expected behaviour? And what about text nodes?
				'<html:img src="/coco/apps/main/img/Icons/product_48.png"/>',
				'<\/template:foo>',
				'<\/mvc:View>'
			],
			oTemplateContent = xml(aTemplateContent),
			fnBindProperty = sap.ui.base.ManagedObject.prototype.bindProperty;

		window.foo = {
			Helper: {
				help: function (oRawValue) {
					if (oRawValue.String) {
						return oRawValue.String;
					}
					if (oRawValue.Path) {
						return "{" + oRawValue.Path + "}";
					}
					return oRawValue;
				}
			}
		};
		sinon.stub(sap.ui.base.ManagedObject.prototype, "bindProperty",
			function (sName, oBindingInfo) {
				strictEqual(sName, "any", "arg name");
				strictEqual(oBindingInfo.mode, sap.ui.model.BindingMode.OneTime, "binding mode");
				fnBindProperty.apply(this, arguments);
			});
		sinon.spy(sap.ui.base.ManagedObject.prototype, "unbindProperty");

		sap.ui.core.util.XMLPreprocessor.process(oTemplateContent, {models: oModel});

		checkXml(oTemplateContent, aExpectedViewContent);
		strictEqual(sap.ui.base.ManagedObject.prototype.unbindProperty.callCount,
				sap.ui.base.ManagedObject.prototype.bindProperty.callCount,
				"balance of bind and unbind");
		ok(sap.ui.base.ManagedObject.prototype.unbindProperty.alwaysCalledWith("any", true));
	});

	//*********************************************************************************************
	test("binding resolution, exception in formatter", function () {
		var oModel = new sap.ui.model.json.JSONModel({
				"com.sap.vocabularies.UI.v1.HeaderInfo": {
					"Title": {
						"Label": {
							"String": "Customer"
						},
						"Value": {
							"Path": "CustomerName"
						}
					}
				}
			}),
			aTemplateContent = [
				mvcView(),
				'<template:foo>',
				'<Label text="{formatter: \'foo.Helper.fail\','
					+ ' path: \'/com.sap.vocabularies.UI.v1.HeaderInfo/Title/Label\'}"/>',
				'<Text text="{formatter: \'foo.Helper.fail\','
					+ ' path: \'/com.sap.vocabularies.UI.v1.HeaderInfo/Title/Value\'}"/>',
				'<\/template:foo>',
				'<\/mvc:View>'
			],
			oTemplateContent = xml(aTemplateContent);

		window.foo = {
			Helper: {
				fail: function (oRawValue) {
					throw new Error("deliberate failure");
				}
			}
		};

		sap.ui.core.util.XMLPreprocessor.process(oTemplateContent, {models: oModel});

		// Note: if template time binding resolution fails, the expression is left "as is"
		checkXml(oTemplateContent, aTemplateContent);
	});

	//*********************************************************************************************
	test("template:with", function () {
		var aViewContent = [
				mvcView(),
				'<template:with path="/some/random/path">',
				'<template:if test="{flag}">',
				'<Icon id="flag"/>',
				'<\/template:if>',
				'<\/template:with>',
				'<\/mvc:View>'
			],
			oModel = new sap.ui.model.json.JSONModel({
				some: {
					random: {
						path: {
							flag: true
						}
					}
				}
			}),
			oViewContent = xml(aViewContent);

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {models: oModel});

		checkXml(oViewContent, aViewContent, [0, 3, 6]);
	});

	//*********************************************************************************************
	test("template:with and 'named context'", function () {
		var aViewContent = [
				mvcView(),
				'<template:with path="/some" var="some">',
				'<template:with path="some>random/path" var="path">',
				'<template:if test="{path>flag}">',
				'<Icon id="flag"/>',
				'<\/template:if>',
				'<\/template:with>',
				'<\/template:with>',
				'<\/mvc:View>'
			],
			oModel = new sap.ui.model.json.JSONModel({
				some: {
					random: {
						path: {
							flag: true
						}
					}
				}
			}),
			oViewContent = xml(aViewContent);

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {models: oModel});

		checkXml(oViewContent, aViewContent, [0, 4, 8]);
	});

	//*********************************************************************************************
	test("template:with and 'named context', missing model", function () {
		var aViewContent = [
				mvcView(),
				'<template:with path="some>random/path" var="path"/>', // "some" not defined here!
				'<\/mvc:View>'
			],
			oViewContent = xml(aViewContent);

		try {
			sap.ui.core.util.XMLPreprocessor.process(oViewContent, {viewName: "foo"});
			ok(false);
		} catch (ex) {
			strictEqual(ex.message,
				"Missing model 'some' in " + aViewContent[1] + " in view foo");
		}
	});

	//*********************************************************************************************
	test("template:with and 'named context', missing context", function () {
		var aViewContent = [
				mvcView(),
				'<template:with path="some/random/place" var="place"/>',
				'<\/mvc:View>'
			],
			oModel = new sap.ui.model.json.JSONModel(), // content does not matter
			oViewContent = xml(aViewContent);

		try {
			sap.ui.core.util.XMLPreprocessor.process(oViewContent,
				{models: oModel, viewName: "foo"});
			ok(false);
		} catch (ex) {
			strictEqual(ex.message,
				'Cannot resolve path for ' + aViewContent[1] + ' in view foo');
		}
	});

	//*********************************************************************************************
	test("template:repeat w/o named models", function () {
		var aTemplateContent = [
				mvcView(),
				'<template:repeat list="{/items}">',
				'<Icon src="{src}"/>',
				'<\/template:repeat>',
				'<\/mvc:View>'
			],
			aExpectedViewContent = [
				aTemplateContent[0],
				'<Icon src="A"/>',
				'<Icon src="B"/>',
				'<Icon src="C"/>',
				'<\/mvc:View>'
			],
			oModel = new sap.ui.model.json.JSONModel({
				items: [{
					src: "A"
				}, {
					src: "B"
				}, {
					src: "C"
				}]
			}),
			oViewContent = xml(aTemplateContent),
			fnBindAggregation = sap.ui.base.ManagedObject.prototype.bindAggregation;

		sinon.stub(sap.ui.base.ManagedObject.prototype, "bindAggregation",
			function (sName, oBindingInfo) {
				strictEqual(sName, "list");
				strictEqual(oBindingInfo.mode, sap.ui.model.BindingMode.OneTime);
				fnBindAggregation.apply(this, arguments);
			});
		sinon.spy(sap.ui.base.ManagedObject.prototype, "unbindAggregation");

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {models: oModel});

		checkXml(oViewContent, aExpectedViewContent);
		strictEqual(sap.ui.base.ManagedObject.prototype.unbindAggregation.callCount,
			sap.ui.base.ManagedObject.prototype.bindAggregation.callCount,
			"balance of bind and unbind");
		ok(sap.ui.base.ManagedObject.prototype.unbindAggregation.alwaysCalledWith("list", true));
	});

	//*********************************************************************************************
	test("template:repeat with named models", function () {
		var aTemplateContent = [
				mvcView(),
				'<template:repeat list="{modelName>/items}">',
				'<Icon src="{modelName>src}"/>',
				'<\/template:repeat>',
				'<\/mvc:View>'
			],
			aExpectedViewContent = [
				aTemplateContent[0],
				'<Icon src="A"/>',
				'<Icon src="B"/>',
				'<Icon src="C"/>',
				'<\/mvc:View>'
			],
			oModel = new sap.ui.model.json.JSONModel({
				items: [{
					src: "A"
				}, {
					src: "B"
				}, {
					src: "C"
				}]
			}),
			oViewContent = xml(aTemplateContent);

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {models: {modelName: oModel}});

		checkXml(oViewContent, aExpectedViewContent);
	});

	//*********************************************************************************************
	test('template:repeat w/o list', function () {
		var aViewContent = [
				mvcView(),
				'<template:repeat/>',
				'<\/mvc:View>'
			],
			oViewContent = xml(aViewContent);

		try {
			sap.ui.core.util.XMLPreprocessor.process(oViewContent, {viewName: "foo"});
			ok(false, "oh");
		} catch (ex) {
			strictEqual(ex.message,
				'Missing binding for ' + aViewContent[1] + ' in view foo');
		}
	});

	//*********************************************************************************************
	test('template:repeat list="no binding"', function () {
		var aViewContent = [
				mvcView(),
				'<template:repeat list="no binding"/>',
				'<\/mvc:View>'
			],
			oViewContent = xml(aViewContent);

		try {
			sap.ui.core.util.XMLPreprocessor.process(oViewContent, {viewName: "foo"});
			ok(false);
		} catch (ex) {
			strictEqual(ex.message,
				'Missing binding for ' + aViewContent[1] + ' in view foo');
		}
	});

	//*********************************************************************************************
	test('template:repeat list="{unknown>foo}"', function () {
		var aViewContent = [
				mvcView(),
				'<template:repeat list="{unknown>foo}"/>',
				'<\/mvc:View>'
			],
			oViewContent = xml(aViewContent);

		try {
			sap.ui.core.util.XMLPreprocessor.process(oViewContent, {viewName: "foo"});
			ok(false);
		} catch (ex) {
			strictEqual(ex.message,
				'Missing model "unknown" in ' + aViewContent[1] + ' in view foo');
		}
	});

	//*********************************************************************************************
	test('template:repeat list="{/unsupported/path}"', function () {
		var aViewContent = [
				mvcView(),
				'<template:repeat list="{/unsupported/path}"/>',
				'<!-- prevent empty tag -->',
				'<\/mvc:View>'
			],
			oModel = new sap.ui.model.json.JSONModel(), // content does not matter
			oViewContent = xml(aViewContent);

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {models: oModel, viewName: "foo"});

		//TODO is this the expected behavior? the loop has no iterations and that's it?
		// Note: the same happens with a relative path if there is no binding context for the model
		checkXml(oViewContent, aViewContent, [0, 2, 3]);
	});

	//*********************************************************************************************
	test("template:repeat w/ complex binding and model", function () {
		var aTemplateContent = [
				mvcView(),
				// Note: foo: 'bar' just serves as placeholder for any parameter (complex syntax)
				'<template:repeat list="{foo: \'bar\', path:\'modelName>/items\'}">',
				'<Icon src="{modelName>src}"/>',
				'<\/template:repeat>',
				'<\/mvc:View>'
			],
			aExpectedViewContent = [
				aTemplateContent[0],
				'<Icon src="A"/>',
				'<Icon src="B"/>',
				'<Icon src="C"/>',
				'<\/mvc:View>'
			],
			oModel = new sap.ui.model.json.JSONModel({
				items: [{
					src: "A"
				}, {
					src: "B"
				}, {
					src: "C"
				}]
			}),
			oViewContent = xml(aTemplateContent);

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {models: {modelName: oModel}});

		checkXml(oViewContent, aExpectedViewContent);
	});

	//*********************************************************************************************
	test("template:repeat nested", function () {
		var aTemplateContent = [
				mvcView(),
				'<template:repeat list="{customer>/orders}">',
				'<Icon src="{customer>id}"/>',
				'<template:repeat list="{customer>items}">',
				'<Icon src="{customer>no}"/>',
				'<\/template:repeat>',
				'<\/template:repeat>',
				'<\/mvc:View>'
			],
			aExpectedViewContent = [
				aTemplateContent[0],
				'<Icon src="A"/>',
				'<Icon src="A1"/>',
				'<Icon src="A2"/>',
				'<Icon src="B"/>',
				'<Icon src="B1"/>',
				'<Icon src="B2"/>',
				'<\/mvc:View>'
			],
			oModel = new sap.ui.model.json.JSONModel({
				orders: [{
					id: "A",
					items: [{
						no: "A1"
					}, {
						no: "A2"
					}]
				}, {
					id: "B",
					items: [{
						no: "B1"
					}, {
						no: "B2"
					}]
				}]
			}),
			oViewContent = xml(aTemplateContent);

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {models: {customer: oModel}});

		checkXml(oViewContent, aExpectedViewContent);
	});

	//*********************************************************************************************
	test("template:repeat with loop variable", function () {
		var aTemplateContent = [
				mvcView(),
				'<template:repeat list="{modelName>/items}" var="item">',
				'<Icon src="{item>src}"/>',
				'<\/template:repeat>',
				'<\/mvc:View>'
			],
			aExpectedViewContent = [
				aTemplateContent[0],
				'<Icon src="A"/>',
				'<Icon src="B"/>',
				'<Icon src="C"/>',
				'<\/mvc:View>'
			],
			oModel = new sap.ui.model.json.JSONModel({
				items: [{
					src: "A"
				}, {
					src: "B"
				}, {
					src: "C"
				}]
			}),
			oViewContent = xml(aTemplateContent);

		sap.ui.core.util.XMLPreprocessor.process(oViewContent, {models: {modelName: oModel}});

		checkXml(oViewContent, aExpectedViewContent);
	});
	</script>

	</head>
	<body><h1 id="qunit-header">QUnit tests: sap.ui.core.util.XMLPreprocessor</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<div id="qunit-testrunner-toolbar"></div>
		<ol id="qunit-tests"></ol>
	</body>
</html>
