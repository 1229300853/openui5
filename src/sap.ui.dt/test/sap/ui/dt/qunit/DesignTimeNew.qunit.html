<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<title>Test Page for sap.ui.dt.DesignTimeNew</title>

		<style>
			#content {
				position: absolute;
				bottom: 0px;
				z-index: 1000;
				width: 700px;
				height: 300px;
			}
		</style>

		<script id="sap-ui-bootstrap"
				data-sap-ui-theme="sap_bluecrystal"
				type="text/javascript"
				data-sap-ui-noConflict="true"
				data-sap-ui-resourceroots='{"dt.view": "testdata/designtime/"}'
				data-sap-ui-libs="sap.ui.dt,sap.m,sap.ui.layout"
				src="../../../../../resources/sap-ui-core.js">
		</script>
		<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen" />
		<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
		<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
		<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
		<script type="text/javascript">

		jQuery.sap.require("sap.ui.dt.Overlay");
			jQuery.sap.require("sap.ui.dt.DesignTimeNew");
			jQuery.sap.require("sap.ui.dt.DragManagerNew");

			module("Given that an DesignTimeNew is created for a root control", {
				setup : function() {
					setupTest.call(this);
				},
				teardown : function() {
					this.oLayout.destroy();
					this.oDesignTime.destroy();
				}
			});

			test("when the DesignTimeNew is initialized ", function() {
				var aOverlays = this.oDesignTime.getOverlays();

				strictEqual(aOverlays.length, 4, "Overlays for 4 elements created");

				ok(isOverlayForElementInDesignTime(this.oLayout, this.oDesignTime), "overlay for layout exists");
				ok(isOverlayForElementInDesignTime(this.oInnerLayout, this.oDesignTime), "overlay for inner layout exists");
				ok(isOverlayForElementInDesignTime(this.oButton1, this.oDesignTime), "overlay for button1 exists");
				ok(isOverlayForElementInDesignTime(this.oButton2, this.oDesignTime), "overlay for button2 exists");
			});

			test("... and new control without overlay is added to a root control aggregation", function() {
				var oButton3 = new sap.m.Button();
				this.oLayout.addContent(oButton3);

				ok(isOverlayForElementInDesignTime(oButton3, this.oDesignTime), "overlay for button3 exists");

				oButton3.destroy();
			});

			test("... and the control is moved inside of root element", function() {
				var oOldButtonOverlay = isOverlayForElementInDesignTime(this.oButton1, this.oDesignTime);
				this.oLayout.addContent(this.oButton1);
				oNewButtonOverlay = isOverlayForElementInDesignTime(this.oButton1, this.oDesignTime);
				strictEqual(oOldButtonOverlay, oNewButtonOverlay, "overlay for button1 is not changed");
			});

			test("... and the control is removed from root element", function() {
				this.oInnerLayout.removeContent(this.oButton1);

				strictEqual(isOverlayForElementInDesignTime(this.oButton1, this.oDesignTime), false, "no overlay for button1");
			});

			module("Given that an DesignTimeNew is created for a root control", {
				setup : function() {
					setupTest.call(this);
				},
				teardown : function() {
					this.oLayout.destroy();
				}
			});

			test("when the DesignTimeNew is destroyed", function() {
				this.oDesignTime.destroy();
				strictEqual(isOverlayForElementInDesignTime(this.oLayout, this.oDesignTime), false, "overlay for layout destroyed");
				strictEqual(isOverlayForElementInDesignTime(this.oButton1, this.oDesignTime), false, "overlay for button1 destroyed");
				strictEqual(isOverlayForElementInDesignTime(this.oButton2, this.oDesignTime), false, "overlay for button2 destroyed");
			});

			module("Given that an DesignTimeNew is created for two root controls", {
				setup : function() {
					this.oLayout1 = new sap.ui.layout.VerticalLayout({
						content : []
					});
					this.oLayout2 = new sap.ui.layout.VerticalLayout({
						content : []
					});
					this.oLayout3 = new sap.ui.layout.VerticalLayout({
						content : []
					});
					this.oLayout = new sap.ui.layout.VerticalLayout({
						content : [this.oLayout1, this.oLayout2, this.oLayout3]
					});
					this.oLayout.placeAt("content");

					this.oDesignTime = new sap.ui.dt.DesignTimeNew({
						rootElements : [this.oLayout1, this.oLayout3]
					});

					sap.ui.getCore().applyChanges();
				},
				teardown : function() {
					this.oLayout.destroy();
					this.oDesignTime.destroy();
				}
			});

			test("when the DesignTimeNew is initialized", function() {
				ok(isOverlayForElementInDesignTime(this.oLayout1, this.oDesignTime), "overlay for layout1 exists");
				strictEqual(isOverlayForElementInDesignTime(this.oLayout2, this.oDesignTime), false, "overlay for layout2 not exists");
				ok(isOverlayForElementInDesignTime(this.oLayout3, this.oDesignTime), "overlay for layout3 exists");
			});

			test("when the DesignTimeNew is initialized and one root element is removed", function() {
				this.oDesignTime.removeRootElement(this.oLayout3);
				ok(isOverlayForElementInDesignTime(this.oLayout1, this.oDesignTime), "overlay for layout1 exists");
				strictEqual(isOverlayForElementInDesignTime(this.oLayout2, this.oDesignTime), false, "overlay for layout2 doesn't exists");
				strictEqual(isOverlayForElementInDesignTime(this.oLayout3, this.oDesignTime), false, "overlay for layout3 doesn't exists");
			});

			test("when the DesignTimeNew is initialized and one root element is removed", function() {
				this.oDesignTime.removeAllRootElement();
				strictEqual(isOverlayForElementInDesignTime(this.oLayout1, this.oDesignTime), false, "overlay for layout1 doesn't exists");
				strictEqual(isOverlayForElementInDesignTime(this.oLayout2, this.oDesignTime), false, "overlay for layout2 doesn't exists");
				strictEqual(isOverlayForElementInDesignTime(this.oLayout3, this.oDesignTime), false, "overlay for layout3 doesn't exists");
			});

			module("Given that an DesignTimeNew is created with a drag manager", {
				setup : function() {
					this.oDragManager = new sap.ui.dt.DragManagerNew();
					this.oDesignTime = new sap.ui.dt.DesignTimeNew({
						managers : [this.oDragManager]
					});
				},
				teardown : function() {
					this.oDragManager.destroy();
					this.oDesignTime.destroy();
				}
			});

			test("...", function() {
				strictEqual(this.oDesignTime.getManagers().length, 1, "one manager is set");
				strictEqual(this.oDesignTime.getManagers()[0], this.oDragManager, "manager is drag manager");
			});

			// TODO test all api methods!

			var setupTest = function() {
				this.oButton1 = new sap.m.Button();
				this.oButton2 = new sap.m.Button();
				this.oInnerLayout = new sap.ui.layout.VerticalLayout({
					content : [
						this.oButton1,
						this.oButton2
					]
				});
				this.oLayout = new sap.ui.layout.VerticalLayout({
					content : [this.oInnerLayout]
				});
				this.oLayout.placeAt("content");
				sap.ui.getCore().applyChanges();
				this.oDesignTime = new sap.ui.dt.DesignTimeNew({
					rootElements : [this.oLayout]
				});
				sap.ui.getCore().applyChanges();
			};		

			var isOverlayForElementInDesignTime = function(oElement, oDesignTime) {
				var bResult = false;

				var aOverlays = oDesignTime.getOverlays();
				var aFoundOverlay = jQuery.each(aOverlays, function(iIndex, oOverlay) {
					if (oOverlay.getElementInstance() === oElement) {
						bResult = true;
						return false;
					}
				});

				return bResult;
			};

		</script>
	</head>
	<body>
		<h1 id="qunit-header">QUnit page for sap.ui.dt.DesignTimeNew</h1>
		<h2 id="qunit-banner"></h2>
	 	<h2 id="qunit-userAgent"></h2>
		<div id="qunit-testrunner-toolbar"></div>
		<ol id="qunit-tests"></ol>
		<div id="content"></div>
	</body>
</html>
